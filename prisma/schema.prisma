// Prisma schema for AIVO core entities (learners, baseline assessments, difficulty proposals)
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Region {
  north_america
  africa
  europe
  australia
  middle_east
  asia
}

enum GradeBand {
  k_5
  six_8
  nine_12
}

enum SubjectCode {
  math
  ela
  reading
  writing
  science
  social_studies
  sel
  speech
  other
}

enum DifficultyChangeDirection {
  easier
  harder
}

enum DifficultyProposalStatus {
  pending
  approved
  rejected
}

enum BaselineStatus {
  draft
  in_progress
  completed
}

model Learner {
  id          String   @id @default(uuid())
  tenantId    String
  userId      String
  displayName String
  currentGrade Int
  region      Region
  createdAt   DateTime @default(now())

  brainProfile        LearnerBrainProfile?
  baselineAssessments BaselineAssessment[]
  difficultyProposals DifficultyChangeProposal[]
  tenant              Tenant              @relation(fields: [tenantId], references: [id])
  owner               User?               @relation("LearnerOwner", fields: [userId], references: [id])
  sessions            Session[]
  notifications       Notification[]
}

model LearnerBrainProfile {
  id             String      @id @default(uuid())
  learnerId      String      @unique
  tenantId       String
  region         Region
  currentGrade   Int
  gradeBand      GradeBand
  subjectLevels  Json
  neurodiversity Json
  preferences    Json
  lastUpdatedAt  DateTime    @updatedAt

  learner Learner @relation(fields: [learnerId], references: [id])
}

model BaselineAssessment {
  id        String         @id @default(uuid())
  learnerId String
  tenantId  String
  region    Region
  grade     Int
  subjects  SubjectCode[]
  items     Json
  createdAt DateTime       @default(now())
  status    BaselineStatus @default(draft)

  learner    Learner                  @relation(fields: [learnerId], references: [id])
  proposals  DifficultyChangeProposal[]
}

model DifficultyChangeProposal {
  id                      String                     @id @default(uuid())
  learnerId               String
  subject                 SubjectCode
  fromAssessedGradeLevel  Int
  toAssessedGradeLevel    Int
  direction               DifficultyChangeDirection
  rationale               String
  createdBy               String
  createdAt               DateTime                   @default(now())
  status                  DifficultyProposalStatus   @default(pending)
  decidedByUserId         String?
  decidedAt               DateTime?
  decisionNotes           String?
  sourceAssessmentId      String?

  learner          Learner?            @relation(fields: [learnerId], references: [id])
  sourceAssessment BaselineAssessment? @relation(fields: [sourceAssessmentId], references: [id])
}

// --- Multi-tenancy & users (added incrementally) ---

model Tenant {
  id        String   @id @default(uuid())
  type      String
  name      String
  region    Region
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  learners       Learner[]
  users          User[]
  roleAssignments RoleAssignment[]
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())

  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  learners       Learner[]      @relation("LearnerOwner")
  notices        Notification[] @relation("NotificationRecipient")
  roleAssignments RoleAssignment[]
}

model RoleAssignment {
  id         String   @id @default(uuid())
  userId     String
  tenantId   String
  districtId String?
  schoolId   String?
  role       String

  user   User   @relation(fields: [userId], references: [id])
  tenant Tenant @relation(fields: [tenantId], references: [id])
}

// --- Sessions & activities (new) ---

model Session {
  id             String   @id @default(uuid())
  learnerId      String
  tenantId       String
  date           String
  subject        SubjectCode
  status         String
  plannedMinutes Int
  actualMinutes  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  learner   Learner @relation(fields: [learnerId], references: [id])
  activities SessionActivity[]
}

model SessionActivity {
  id              String   @id @default(uuid())
  sessionId       String
  learnerId       String
  subject         SubjectCode
  type            String
  title           String
  instructions    String
  estimatedMinutes Int
  status          String
  startedAt       DateTime?
  completedAt     DateTime?

  session Session @relation(fields: [sessionId], references: [id])
}

// --- Notifications (new, initially with optional relations) ---

model Notification {
  id        String   @id @default(uuid())
  tenantId  String
  learnerId String
  recipientUserId String

  audience  String
  type      String
  title     String
  body      String
  status    String
  createdAt DateTime @default(now())

  relatedDifficultyProposalId String?
  relatedBaselineAssessmentId String?
  relatedSessionId            String?

  learner   Learner? @relation(fields: [learnerId], references: [id])
  recipient User     @relation("NotificationRecipient", fields: [recipientUserId], references: [id])
}
