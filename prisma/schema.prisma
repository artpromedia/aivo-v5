generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id             String             @id @default(cuid())
  email          String?            @unique
  username       String             @unique
  name           String?
  password       String
  role           Role
  tenantId       String?
  tenant         Tenant?            @relation(fields: [tenantId], references: [id])
  isActive       Boolean            @default(true)
  lastLogin      DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  profile        Profile?
  roles          RoleAssignment[]   @relation("UserRoles")
  learners       Learner[]          @relation("GuardianLearners")
  ownedLearners  Learner[]          @relation("LearnerOwner")
  learnerProfile Learner?
  teacherClasses Class[]            @relation("TeacherClasses")
  approvals      ApprovalRequest[]  @relation("ApproverRequests")
  notifications  Notification[]
  sessions       Session[]
  createdUnits CurriculumUnit[] @relation("UnitCreators")
  createdModules CurriculumModule[] @relation("ModuleCreators")
  authoredCurriculum CurriculumContent[] @relation("ContentCreators")
  updatedCurriculum CurriculumContent[] @relation("ContentUpdaters")
  createdContentVersions ContentVersion[] @relation("VersionCreators")
  reviewedContentVersions ContentVersion[] @relation("VersionReviewers")
  contentInteractions ContentInteraction[] @relation("UserContentInteractions")
  sentMessages Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageRecipient")
  requestedInsights AIInsight[] @relation("InsightRequester")
  receivedInsights AIInsight[] @relation("InsightRecipient")
  createdMeetings Meeting[] @relation("MeetingCreator")
  meetingParticipations MeetingParticipant[]
  announcementsCreated Announcement[] @relation("AnnouncementCreator")
  notificationPreference NotificationPreference?
  communicationLogs CommunicationLog[]
  accounts       Account[]
}

model Profile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  firstName   String
  lastName    String
  phone       String?
  address     String?
  preferences Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Learner {
  id              String             @id @default(cuid())
  userId          String             @unique
  user            User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  guardianId      String
  guardian        User               @relation("GuardianLearners", fields: [guardianId], references: [id])
  ownerId         String?
  owner           User?              @relation("LearnerOwner", fields: [ownerId], references: [id])
  tenantId        String?
  tenant          Tenant?            @relation(fields: [tenantId], references: [id])
  districtId      String?
  district        District?          @relation(fields: [districtId], references: [id])
  schoolId        String?
  school          School?            @relation(fields: [schoolId], references: [id])
  firstName       String
  lastName        String
  region          String?            @default("north_america")
  dateOfBirth     DateTime
  gradeLevel      Int
  currentGrade    Int?
  actualLevel     Float?
  brainProfile    BrainProfile?
  difficultyProposals DifficultyProposal[]
  plannedSessions PlannedSession[]
  progressSnapshots SubjectProgressSnapshot[]
  telemetryEvents TelemetryEvent[]
  safetyIncidents SafetyIncident[]
  diagnoses       Diagnosis[]
  accommodations  Json?
  iepGoals        IEPGoal[]
  assessments     Assessment[]
  approvalRequests ApprovalRequest[]
  adjustmentLogs  LearningAdjustmentLog[]
  learningModel   PersonalizedModel?
  sessions        LearningSession[]
  progress        Progress[]
  focusData       FocusData[]
  gameHistory     GameSession[]
  enrollments     Enrollment[]
  experimentAssignments ExperimentAssignment[]
  feedbackEntries Feedback[]
  contentInteractions ContentInteraction[] @relation("LearnerContentInteractions")
  baselineSessions BaselineAssessmentSession[]
  speechSamples    SpeechAssessmentSample[]
  notifications    Notification[]
  messages         Message[]
  aiInsights       AIInsight[]
  communicationLogs CommunicationLog[]
  accommodationPlan LearnerAccommodation? @relation("LearnerAccommodationPlan")
  accommodationMetrics AccommodationEffectiveness[] @relation("LearnerAccommodationMetrics")
  agentStates      AgentState[]
  agentInteractions AgentInteraction[]
  homeworkSessions HomeworkSession[]
  regulationSessions RegulationSession[]
  emotionHistory   EmotionHistory[]
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model BaselineAssessmentSession {
  id               String                   @id @default(cuid())
  learnerId        String
  status           BaselineAssessmentStatus @default(IN_PROGRESS)
  currentDomain    BaselineDomain?
  currentComponent String?
  plan             Json?
  multiModalPlan   Json?
  aiSummary        Json?
  startedAt        DateTime                @default(now())
  completedAt      DateTime?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  learner       Learner                @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  domainResults BaselineDomainResult[]
  speechSamples SpeechAssessmentSample[]

  @@index([learnerId, status])
}

model BaselineDomainResult {
  id         String   @id @default(cuid())
  sessionId  String
  domain     BaselineDomain
  component  String
  modality   String
  responses  Json?
  score      Float?
  confidence Float?
  aiNotes    String?
  createdAt  DateTime @default(now())

  session BaselineAssessmentSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId, domain])
}

model SpeechAssessmentSample {
  id              String   @id @default(cuid())
  learnerId       String
  sessionId       String?
  taskType        String
  component       String?
  audioFormat     String?
  audioBase64     String?
  durationMs      Int?
  articulation    Float?
  fluency         Float?
  intelligibility Float?
  metadata        Json?
  analysis        Json?
  createdAt       DateTime @default(now())

  learner Learner                  @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  session BaselineAssessmentSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@index([learnerId])
  @@index([sessionId])
}

model Diagnosis {
  id          String   @id @default(cuid())
  learnerId   String
  learner     Learner  @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  type        String
  description String?
  severity    String?
  notes       String?
  diagnosedAt DateTime?
  createdAt   DateTime @default(now())
}

model Assessment {
  id           String            @id @default(cuid())
  learnerId    String
  learner      Learner           @relation(fields: [learnerId], references: [id])
  type         AssessmentType
  status       AssessmentStatus
  domains      AssessmentDomain[]
  results      Json?
  overallLevel Float?
  startedAt    DateTime
  completedAt  DateTime?
  createdAt    DateTime         @default(now())
}

model AssessmentDomain {
  id           String      @id @default(cuid())
  assessmentId String
  assessment   Assessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  domain       DomainType
  questions    Json
  responses    Json
  score        Float?
  level        Float?
  createdAt    DateTime    @default(now())
}

model PersonalizedModel {
  id                 String                  @id @default(cuid())
  learnerId          String                  @unique
  learner            Learner                 @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  modelId            String?
  systemPrompt       String?                 @db.Text
  vectorStoreId      String?
  configuration      Json
  status             PersonalizedModelStatus @default(PENDING)
  summary            String?
  version            Int                     @default(1)
  performanceMetrics Json?
  lastTrainedAt      DateTime?
  metadata           Json? // Stores federated learning metadata
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  trainingSessions   ModelTrainingSession[]
}

model MainModelVersion {
  id                String              @id @default(cuid())
  version           String              @unique
  modelPath         String
  architecture      Json
  trainingMetrics   Json
  status            ModelVersionStatus  @default(ACTIVE)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  federatedUpdates  FederatedUpdate[]
}

model FederatedUpdate {
  id                     String            @id @default(cuid())
  mainModelVersionId     String
  mainModelVersion       MainModelVersion  @relation(fields: [mainModelVersionId], references: [id], onDelete: Cascade)
  aggregationStrategy    String
  contributingLearners   String[]
  performanceImprovement Float
  privacyBudget          Float?
  metadata               Json?
  createdAt              DateTime          @default(now())
}

model ModelTrainingSession {
  id                      String             @id @default(cuid())
  personalizedModelId     String
  personalizedModel       PersonalizedModel  @relation(fields: [personalizedModelId], references: [id], onDelete: Cascade)
  epochs                  Int
  batchSize               Int
  samples                 Int
  finalLoss               Float
  finalAccuracy           Float
  contributedToFederation Boolean            @default(false)
  federatedUpdateId       String?
  metadata                Json?
  createdAt               DateTime           @default(now())
}

model LearningAdjustmentLog {
  id            String   @id @default(cuid())
  learnerId     String
  previousLevel Float
  newLevel      Float
  approvedBy    String
  approvedAt    DateTime @default(now())
  reasoning     String?
  createdAt     DateTime @default(now())

  learner Learner @relation(fields: [learnerId], references: [id], onDelete: Cascade)
}

model LearningSession {
  id                String    @id @default(cuid())
  learnerId         String
  learner           Learner   @relation(fields: [learnerId], references: [id])
  subject           String
  topic             String
  gradeLevel        Int
  presentationLevel Float
  startTime         DateTime
  endTime           DateTime?
  duration          Int?
  interactions      Json
  focusScore        Float?
  completion        Float?
  createdAt         DateTime @default(now())
}

model FocusData {
  id            String    @id @default(cuid())
  learnerId     String
  learner       Learner   @relation(fields: [learnerId], references: [id])
  sessionId     String?
  focusScore    Float
  distractions  Int
  timestamp     DateTime
  metrics       Json
  createdAt     DateTime @default(now())
}

model GameSession {
  id                String    @id @default(cuid())
  learnerId         String
  learner           Learner   @relation(fields: [learnerId], references: [id])
  gameType          GameType
  subject           String?
  difficulty        Int
  duration          Int
  score             Int?
  completed         Boolean
  triggeredBy       String
  returnedToLearning Boolean @default(false)
  createdAt         DateTime @default(now())
}

model Progress {
  id        String     @id @default(cuid())
  learnerId String
  learner   Learner    @relation(fields: [learnerId], references: [id])
  domain    DomainType
  date      DateTime
  level     Float
  score     Float?
  timeSpent Int
  createdAt DateTime   @default(now())
}

model ApprovalRequest {
  id          String         @id @default(cuid())
  type        ApprovalType
  learnerId   String
  requesterId String
  approverId  String
  learner     Learner        @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  approver    User           @relation("ApproverRequests", fields: [approverId], references: [id])
  status      ApprovalStatus
  details     Json
  comments    String?
  createdAt   DateTime       @default(now())
  decidedAt   DateTime?
}

model Class {
  id          String        @id @default(cuid())
  name        String
  description String?
  gradeLevel  Int
  teacherId   String
  teacher     User          @relation("TeacherClasses", fields: [teacherId], references: [id])
  enrollments Enrollment[]
  assignments Assignment[]
  startDate   DateTime
  endDate     DateTime?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
}

model Enrollment {
  id         String            @id @default(cuid())
  learnerId  String
  learner    Learner           @relation(fields: [learnerId], references: [id])
  classId    String
  class      Class             @relation(fields: [classId], references: [id])
  enrolledAt DateTime          @default(now())
  status     EnrollmentStatus

  @@unique([learnerId, classId])
}

model Assignment {
  id          String   @id @default(cuid())
  classId     String
  class       Class    @relation(fields: [classId], references: [id])
  title       String
  description String?
  type        String
  content     Json
  dueDate     DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  learnerId String?
  user      User     @relation(fields: [userId], references: [id])
  type      String
  title     String
  message   String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  learner Learner? @relation(fields: [learnerId], references: [id])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model CurriculumTopic {
  id          String       @id @default(cuid())
  tenantId    String
  subject     String
  grade       Int
  region      String
  standard    String
  code        String?
  title       String
  description String?
  content     ContentItem[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model LearnerAccommodation {
  id            String             @id @default(cuid())
  learnerId     String             @unique
  accommodations AccommodationType[]
  autoEnabled   Boolean            @default(false)
  autoEnabledAt DateTime?
  notes         String?
  metadata      Json?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  learner Learner @relation("LearnerAccommodationPlan", fields: [learnerId], references: [id], onDelete: Cascade)
}

model AccommodationEffectiveness {
  id                 String             @id @default(cuid())
  learnerId          String
  accommodation      AccommodationType
  sessionId          String?
  engagementWith     Float?
  completionRateWith Float?
  accuracyWith       Float?
  timeOnTaskWith     Float?
  metadata           Json?
  createdAt          DateTime           @default(now())

  learner Learner @relation("LearnerAccommodationMetrics", fields: [learnerId], references: [id], onDelete: Cascade)

  @@index([learnerId, accommodation])
}

model ContentItem {
  id                 String          @id @default(cuid())
  tenantId           String
  topicId            String
  topic              CurriculumTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)
  subject            String
  grade              Int
  type               String
  title              String
  body               String
  questionFormat     String?
  options            Json?
  correctAnswer      String?
  accessibilityNotes String?
  status             String
  createdByUserId    String
  aiGenerated        Boolean         @default(false)
  aiModel            String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
}

model LearningStandard {
  id           String             @id @default(cuid())
  code         String
  jurisdiction String
  gradeBand    String
  subject      String
  skillFocus   String?
  description  String?
  tags         String[]           @default([])
  metadata     Json?
  isActive     Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  units          CurriculumUnit[]   @relation("UnitStandards")
  primaryContent CurriculumContent[] @relation("ContentStandards")
  alignedContent CurriculumContent[] @relation("CurriculumContentStandards")

  @@unique([code, jurisdiction])
}

model CurriculumUnit {
  id          String                 @id @default(cuid())
  title       String
  description String?
  subject     String
  gradeBand   String
  gradeLevel  Int?
  focusSkills String[]               @default([])
  status      CurriculumUnitStatus   @default(DRAFT)
  createdById String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  createdBy User?             @relation("UnitCreators", fields: [createdById], references: [id])
  modules   CurriculumModule[]
  standards LearningStandard[] @relation("UnitStandards")
}

model CurriculumModule {
  id              String                 @id @default(cuid())
  unitId          String
  title           String
  description     String?
  subject         String?
  targetGrade     Int?
  skillFocus      String?
  durationMinutes Int?
  sequence        Int?
  status          CurriculumModuleStatus @default(DRAFT)
  createdById     String?
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  unit       CurriculumUnit   @relation(fields: [unitId], references: [id])
  createdBy  User?            @relation("ModuleCreators", fields: [createdById], references: [id])
  content    CurriculumContent[]
  prerequisites ModulePrerequisite[] @relation("ModulePrerequisites")
  dependents    ModulePrerequisite[] @relation("ModuleDependency")

  @@index([unitId])
}

model ModulePrerequisite {
  id              String           @id @default(cuid())
  moduleId        String
  prerequisiteId  String

  module       CurriculumModule @relation("ModulePrerequisites", fields: [moduleId], references: [id], onDelete: Cascade)
  prerequisite CurriculumModule @relation("ModuleDependency", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([moduleId, prerequisiteId])
}

model CurriculumContent {
  id                String                   @id @default(cuid())
  moduleId          String
  title             String
  summary           String?
  contentType       CurriculumContentType
  difficultyLevel   Float?
  primaryStandardId String?
  aiTags            String[]                 @default([])
  status            CurriculumContentStatus  @default(ACTIVE)
  createdById       String?
  updatedById       String?
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt

  module          CurriculumModule  @relation(fields: [moduleId], references: [id])
  primaryStandard LearningStandard? @relation("ContentStandards", fields: [primaryStandardId], references: [id])
  createdBy       User?             @relation("ContentCreators", fields: [createdById], references: [id])
  updatedBy       User?             @relation("ContentUpdaters", fields: [updatedById], references: [id])
  versions        ContentVersion[]
  interactions    ContentInteraction[]
  effectiveness   ContentEffectiveness[]

  standards LearningStandard[] @relation("CurriculumContentStandards")

  @@index([moduleId])
  @@index([primaryStandardId])
}

model ContentVersion {
  id               String                 @id @default(cuid())
  contentId        String
  versionNumber    Int
  source           ContentVersionSource   @default(AUTHOR)
  status           ContentVersionStatus   @default(DRAFT)
  prompt           String?
  aiModel          String?
  diffSummary      String?
  adaptationContext Json?
  aiConfidence     Float?
  payload          Json?
  createdById      String?
  reviewedById     String?
  publishedAt      DateTime?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  content    CurriculumContent @relation(fields: [contentId], references: [id])
  createdBy  User?             @relation("VersionCreators", fields: [createdById], references: [id])
  reviewedBy User?             @relation("VersionReviewers", fields: [reviewedById], references: [id])
  assets     ContentAsset[]
  interactions ContentInteraction[]
  effectiveness ContentEffectiveness[]

  @@unique([contentId, versionNumber])
  @@index([status])
}

model ContentAsset {
  id            String           @id @default(cuid())
  versionId     String
  assetType     ContentAssetType
  title         String?
  uri           String?
  mimeType      String?
  textContent   String?
  durationSeconds Int?
  metadata      Json?
  createdAt     DateTime         @default(now())

  version ContentVersion @relation(fields: [versionId], references: [id])

  @@index([versionId])
}

model ContentInteraction {
  id             String                 @id @default(cuid())
  contentId      String
  versionId      String?
  learnerId      String?
  userId         String?
  interactionType ContentInteractionType
  modality       String?
  durationSeconds Int?
  feedbackRating  Int?
  feedbackComment String?
  masteryEvidence Json?
  metadata        Json?
  createdAt       DateTime               @default(now())

  content   CurriculumContent @relation(fields: [contentId], references: [id])
  version   ContentVersion?   @relation(fields: [versionId], references: [id])
  learner   Learner?          @relation("LearnerContentInteractions", fields: [learnerId], references: [id])
  user      User?             @relation("UserContentInteractions", fields: [userId], references: [id])

  @@index([contentId])
  @@index([learnerId])
  @@index([userId])
}

model ContentEffectiveness {
  id               String    @id @default(cuid())
  contentId        String
  versionId        String?
  date             DateTime
  engagementScore  Float     @default(0)
  masteryDelta     Float     @default(0)
  aiQualityScore   Float     @default(0)
  educatorSentiment Float    @default(0)
  sampleSize       Int       @default(0)
  metadata         Json?
  createdAt        DateTime  @default(now())

  content CurriculumContent @relation(fields: [contentId], references: [id])
  version ContentVersion?   @relation(fields: [versionId], references: [id])

  @@unique([contentId, date])
  @@index([versionId])
}

model Experiment {
  id             String                 @id @default(cuid())
  tenantId       String
  key            String                 @unique
  name           String
  status         String
  description    String?
  variants       Json
  targeting      Json?
  createdByUserId String?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  assignments    ExperimentAssignment[]
  feedback       Feedback[]
}

model ExperimentAssignment {
  id           String      @id @default(cuid())
  experimentId String
  experiment   Experiment  @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  learnerId    String
  learner      Learner     @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  variantKey   String
  metadata     Json?
  createdAt    DateTime    @default(now())

  @@unique([experimentId, learnerId])
}

model Feedback {
  id           String     @id @default(cuid())
  tenantId     String
  learnerId    String?
  learner      Learner?   @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  userId       String?
  targetType   String
  targetId     String
  role         String
  rating       Int
  label        String?
  comment      String?
  experimentId String?
  experiment   Experiment? @relation(fields: [experimentId], references: [id], onDelete: Cascade)
  experimentKey String?
  variantKey   String?
  metadata     Json?
  createdAt    DateTime   @default(now())
}

model IEPGoal {
  id         String     @id @default(cuid())
  learnerId  String
  learner    Learner    @relation(fields: [learnerId], references: [id])
  goal       String
  category   String
  targetDate DateTime
  status     GoalStatus @default(NOT_STARTED)
  progress   Float      @default(0)
  notes      String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
}

model Message {
  id        String       @id @default(cuid())
  fromId    String
  toId      String
  learnerId String?
  type      MessageType  @default(TEXT)
  content   String
  metadata  Json?
  readAt    DateTime?
  createdAt DateTime     @default(now())

  fromUser User   @relation("MessageSender", fields: [fromId], references: [id])
  toUser   User   @relation("MessageRecipient", fields: [toId], references: [id])
  learner  Learner? @relation(fields: [learnerId], references: [id])

  @@index([toId, createdAt])
  @@index([learnerId])
}

model AIInsight {
  id             String          @id @default(cuid())
  learnerId      String
  requesterId    String?
  generatedForId String?
  type           String
  summary        String
  content        Json
  recommendations Json?
  priority       InsightPriority @default(MEDIUM)
  createdAt      DateTime        @default(now())

  learner      Learner @relation(fields: [learnerId], references: [id])
  requester    User?   @relation("InsightRequester", fields: [requesterId], references: [id])
  generatedFor User?   @relation("InsightRecipient", fields: [generatedForId], references: [id])
}

model Meeting {
  id            String   @id @default(cuid())
  roomId        String   @unique
  roomLink      String
  topic         String
  scheduledTime DateTime
  duration      Int?
  createdById   String?
  createdAt     DateTime @default(now())

  createdBy    User?                 @relation("MeetingCreator", fields: [createdById], references: [id])
  participants MeetingParticipant[]
}

model MeetingParticipant {
  id         String   @id @default(cuid())
  meetingId  String
  userId     String
  status     MeetingParticipantStatus @default(PENDING)
  inviteSent DateTime? @default(now())
  joinedAt   DateTime?

  meeting Meeting @relation(fields: [meetingId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([meetingId, userId])
}

model Announcement {
  id          String               @id @default(cuid())
  title       String
  content     String
  priority    AnnouncementPriority @default(MEDIUM)
  recipients  String[]
  createdById String?
  createdAt   DateTime             @default(now())

  createdBy User? @relation("AnnouncementCreator", fields: [createdById], references: [id])
}

model NotificationPreference {
  id              String           @id @default(cuid())
  userId          String           @unique
  channels        Json
  digestFrequency DigestFrequency  @default(INSTANT)
  muteUntil       DateTime?
  updatedAt       DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model CommunicationLog {
  id        String                @id @default(cuid())
  userId    String?
  learnerId String?
  type      CommunicationLogType
  channel   String
  payload   Json
  createdAt DateTime              @default(now())

  user    User?    @relation(fields: [userId], references: [id])
  learner Learner? @relation(fields: [learnerId], references: [id])

  @@index([userId])
  @@index([learnerId])
}

model MLTrainingData {
  id        String   @id @default(cuid())
  learnerId String
  timestamp DateTime @default(now())
  features  Json
  labels    Json
  outcome   Json?
  createdAt DateTime @default(now())

  @@index([learnerId])
  @@index([timestamp])
}

enum Role {
  ADMIN
  TEACHER
  PARENT
  LEARNER
}

enum AssessmentType {
  BASELINE
  PROGRESS
  DIAGNOSTIC
  SUMMATIVE
}

enum AssessmentStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum DomainType {
  READING
  MATH
  SPEECH
  SEL
  SCIENCE
}

enum BaselineDomain {
  SPEECH_LANGUAGE
  READING
  MATH
  SCIENCE_SOCIAL
  SEL
}

enum BaselineAssessmentStatus {
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum PersonalizedModelStatus {
  PENDING
  TRAINING
  ACTIVE
  UPDATING
  FAILED
  ERROR
}

enum ModelVersionStatus {
  ACTIVE
  ARCHIVED
  DEPRECATED
}

enum AccommodationType {
  TEXT_TO_SPEECH
  INCREASED_FONT_SIZE
  HIGH_CONTRAST
  REDUCED_VISUAL_CLUTTER
  VISUAL_SCHEDULES
  COLOR_CODING
  DYSLEXIA_FONT
  CAPTIONS
  AUDIO_INSTRUCTIONS
  SLOWED_AUDIO
  SPEECH_TO_TEXT
  SIMPLIFIED_CONTROLS
  LARGER_CLICK_TARGETS
  EXTRA_TIME
  FREQUENT_BREAKS
  REDUCED_CHOICES
  CHUNKED_CONTENT
  WORKED_EXAMPLES
  STEP_BY_STEP
  ENCOURAGEMENT_PROMPTS
  FIDGET_TOOLS
  CALM_DOWN_STRATEGIES
  CHOICE_IN_ACTIVITIES
}

enum ModelStatus {
  TRAINING
  ACTIVE
  UPDATING
  FAILED
}

enum GameType {
  PUZZLE
  MEMORY
  QUIZ
  MOVEMENT
  CREATIVE
}

enum ApprovalType {
  DIFFICULTY_CHANGE
  CONTENT_MODIFICATION
  ASSESSMENT_RETRY
  GOAL_ADJUSTMENT
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ACHIEVED
  MODIFIED
}

enum MessageType {
  TEXT
  CONCERN
  QUESTION
  ALERT
  SYSTEM
}

enum InsightPriority {
  LOW
  MEDIUM
  HIGH
}

enum MeetingParticipantStatus {
  PENDING
  ACCEPTED
  DECLINED
}

enum AnnouncementPriority {
  LOW
  MEDIUM
  HIGH
}

enum DigestFrequency {
  INSTANT
  DAILY
  WEEKLY
}

enum CommunicationLogType {
  MESSAGE
  INSIGHT
  MEETING
  ANNOUNCEMENT
  NOTIFICATION
}

enum CurriculumUnitStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CurriculumModuleStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum CurriculumContentType {
  LESSON
  ACTIVITY
  ASSESSMENT
  SUPPORT
  RESOURCE
}

enum CurriculumContentStatus {
  ACTIVE
  ARCHIVED
}

enum ContentVersionSource {
  AUTHOR
  AI
  FALLBACK
}

enum ContentVersionStatus {
  DRAFT
  IN_REVIEW
  ACTIVE
  ARCHIVED
}

enum ContentAssetType {
  TEXT
  AUDIO
  VIDEO
  IMAGE
  INTERACTIVE
  HAPTIC
}

enum ContentInteractionType {
  VIEW
  DELIVERY
  ASSIGNMENT
  FEEDBACK
  AI_RECOMMENDATION
}

// NextAuth Authentication Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([provider, providerAccountId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// Agent System Models
model AgentState {
  id                  String      @id @default(cuid())
  agentId             String      @unique
  learnerId           String
  learner             Learner     @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  
  agentType           AgentType
  state               Json
  memory              Json
  lastActivity        DateTime
  
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  
  @@index([learnerId])
  @@index([lastActivity])
  @@index([agentType])
}

enum AgentType {
  PERSONALIZED_LEARNING
  AI_TUTOR
  CONTENT_ADAPTATION
  SPEECH_ANALYSIS
  PROGRESS_MONITORING
}

model AgentInteraction {
  id                  String      @id @default(cuid())
  learnerId           String
  learner             Learner     @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  
  agentId             String
  interactionType     String
  input               Json
  output              Json
  
  durationMs          Int?
  success             Boolean     @default(true)
  errorMessage        String?
  
  createdAt           DateTime    @default(now())
  
  @@index([learnerId])
  @@index([agentId])
  @@index([createdAt])
}

// ============================================================================
// MULTI-TENANT MODELS
// These support the federated multi-tenant structure where each child has
// their own learning brain while being part of a district/school hierarchy
// ============================================================================

model Tenant {
  id              String         @id @default(cuid())
  name            String
  type            TenantType     @default(DISTRICT)
  region          String         @default("north_america")
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  config          TenantConfig?
  users           User[]
  learners        Learner[]
  districts       District[]
  schools         School[]
  roleAssignments RoleAssignment[]
  difficultyProposals DifficultyProposal[]
  notifications   ExtendedNotification[]
  plannedSessions PlannedSession[]
  telemetryEvents TelemetryEvent[]
  tenantLimits    TenantLimits?
  tenantUsage     TenantUsage[]
  auditLogs       AuditLogEntry[]
  safetyIncidents SafetyIncident[]

  @@index([region])
  @@index([type])
}

model TenantConfig {
  id               String   @id @default(cuid())
  tenantId         String   @unique
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  defaultRegion    String   @default("north_america")
  allowedProviders Json     @default("[\"openai\", \"anthropic\"]")
  blockedProviders Json     @default("[]")
  dataResidency    String?
  curricula        Json     @default("[]")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model District {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  country   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schools         School[]
  learners        Learner[]
  roleAssignments RoleAssignment[]

  @@index([tenantId])
}

model School {
  id         String    @id @default(cuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  districtId String?
  district   District? @relation(fields: [districtId], references: [id])
  name       String
  city       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  learners        Learner[]
  roleAssignments RoleAssignment[]

  @@index([tenantId])
  @@index([districtId])
}

model RoleAssignment {
  id         String    @id @default(cuid())
  userId     String
  user       User      @relation("UserRoles", fields: [userId], references: [id], onDelete: Cascade)
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  districtId String?
  district   District? @relation(fields: [districtId], references: [id])
  schoolId   String?
  school     School?   @relation(fields: [schoolId], references: [id])
  role       String
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([role])
}

enum TenantType {
  DISTRICT
  INDEPENDENT_SCHOOL
  CLINIC
  HOMESCHOOL_NETWORK
}

// ============================================================================
// BRAIN PROFILE - The learner's personalized learning configuration
// This is the "virtual brain" that adapts to each child's unique needs
// ============================================================================

model BrainProfile {
  id              String   @id @default(cuid())
  learnerId       String   @unique
  learner         Learner  @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  region          String   @default("north_america")
  currentGrade    Int
  gradeBand       String   // k_5, 6_8, 9_12
  subjectLevels   Json     @default("[]") // Array of {subject, level, lastAssessed}
  neurodiversity  Json     @default("{}") // ADHD, Dyslexia, Autism configs
  preferences     Json     @default("{}") // Learning style preferences
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([region])
  @@index([gradeBand])
}

// ============================================================================
// DIFFICULTY PROPOSAL - System for adjusting learning difficulty
// Allows AI to propose changes, with parent/teacher approval
// ============================================================================

model DifficultyProposal {
  id            String    @id @default(cuid())
  learnerId     String
  learner       Learner   @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subject       String
  fromLevel     Float
  toLevel       Float
  direction     String    // "easier" | "harder"
  rationale     String    @db.Text
  createdBy     String    // "system" | "teacher" | "parent"
  status        DifficultyProposalStatus @default(PENDING)
  decidedById   String?
  decidedAt     DateTime?
  decisionNotes String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  notifications ExtendedNotification[]

  @@index([learnerId])
  @@index([tenantId])
  @@index([status])
}

enum DifficultyProposalStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// PLANNED SESSION - Learning sessions with activities
// Tracks daily learning plans and activity completion
// ============================================================================

model PlannedSession {
  id             String           @id @default(cuid())
  learnerId      String
  learner        Learner          @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  tenantId       String
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date           String           // YYYY-MM-DD format
  subject        String
  status         PlannedSessionStatus @default(PLANNED)
  plannedMinutes Int
  actualMinutes  Int?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  activities     SessionActivity[]

  @@index([learnerId, date])
  @@index([tenantId])
  @@index([status])
}

model SessionActivity {
  id               String   @id @default(cuid())
  sessionId        String
  session          PlannedSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  learnerId        String
  subject          String
  type             String
  title            String
  instructions     String   @db.Text
  estimatedMinutes Int
  status           SessionActivityStatus @default(PENDING)
  startedAt        DateTime?
  completedAt      DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([sessionId])
  @@index([status])
}

enum PlannedSessionStatus {
  PLANNED
  ACTIVE
  COMPLETED
  CANCELLED
}

enum SessionActivityStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

// ============================================================================
// ANALYTICS & TELEMETRY - Track learner progress and engagement
// ============================================================================

model SubjectProgressSnapshot {
  id              String   @id @default(cuid())
  learnerId       String
  learner         Learner  @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  subject         String
  date            String   // YYYY-MM-DD
  masteryScore    Float
  minutesPracticed Int
  difficultyLevel Float
  createdAt       DateTime @default(now())

  @@unique([learnerId, subject, date])
  @@index([learnerId])
  @@index([date])
}

model TelemetryEvent {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  learnerId String
  learner   Learner  @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  type      String
  subject   String?
  payload   Json     @default("{}")
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([learnerId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// GOVERNANCE - Rate limiting, usage tracking, and audit logs
// ============================================================================

model TenantLimits {
  id                 String   @id @default(cuid())
  tenantId           String   @unique
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  maxDailyLlmCalls   Int?
  maxDailyTutorTurns Int?
  allowedProviders   Json     @default("[\"openai\", \"anthropic\"]")
  blockedProviders   Json     @default("[]")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model TenantUsage {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date            String   // YYYY-MM-DD
  llmCalls        Int      @default(0)
  tutorTurns      Int      @default(0)
  sessionsPlanned Int      @default(0)
  safetyIncidents Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
}

model AuditLogEntry {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId    String
  type      String
  message   String   @db.Text
  meta      Json?
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// ============================================================================
// SAFETY - Track and respond to safety incidents
// ============================================================================

model SafetyIncident {
  id               String   @id @default(cuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  learnerId        String?
  learner          Learner? @relation(fields: [learnerId], references: [id], onDelete: SetNull)
  type             String
  severity         SafetySeverity
  message          String   @db.Text
  rawModelResponse String?  @db.Text
  createdAt        DateTime @default(now())

  @@index([tenantId])
  @@index([learnerId])
  @@index([severity])
  @@index([createdAt])
}

enum SafetySeverity {
  WATCH
  CONCERN
  CRITICAL
}

// ============================================================================
// EXTENDED NOTIFICATION - Multi-tenant notifications with more fields
// ============================================================================

model ExtendedNotification {
  id                         String    @id @default(cuid())
  tenantId                   String
  tenant                     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  learnerId                  String?
  recipientUserId            String
  audience                   String    // "parent" | "teacher" | "admin"
  type                       String
  title                      String
  body                       String    @db.Text
  status                     String    @default("unread") // "unread" | "read"
  relatedDifficultyProposalId String?
  difficultyProposal         DifficultyProposal? @relation(fields: [relatedDifficultyProposalId], references: [id])
  createdAt                  DateTime  @default(now())

  @@index([tenantId])
  @@index([recipientUserId])
  @@index([status])
}

// ============================================================================
// HOMEWORK HELPER - Scaffolded homework assistance for learners
// ============================================================================

model HomeworkSession {
  id                  String                @id @default(cuid())
  learnerId           String
  learner             Learner               @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  title               String
  subject             String?               // Detected or specified subject
  gradeLevel          Int?                  // Detected or specified grade level
  status              HomeworkSessionStatus @default(UNDERSTAND)
  difficultyMode      HomeworkDifficultyMode @default(SCAFFOLDED)
  parentAssistMode    Boolean               @default(false)
  hintsUsed           Int                   @default(0)
  maxHintsPerStep     Int                   @default(3)
  currentStepHints    Int                   @default(0)
  problemAnalysis     Json?                 // Stored ProblemAnalysis from UNDERSTAND step
  solutionPlan        Json?                 // Stored SolutionPlan from PLAN step
  finalAnswer         Json?                 // Learner's final answer
  verificationResult  Json?                 // Stored VerificationResult from CHECK step
  completedAt         DateTime?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime              @updatedAt
  
  files               HomeworkFile[]
  workProducts        HomeworkWorkProduct[]
  hints               HomeworkHint[]

  @@index([learnerId])
  @@index([status])
  @@index([createdAt])
}

enum HomeworkSessionStatus {
  UNDERSTAND
  PLAN
  SOLVE
  CHECK
  COMPLETE
}

enum HomeworkDifficultyMode {
  SIMPLIFIED    // Extra scaffolding, simpler language
  SCAFFOLDED    // Standard scaffolding with hints
  STANDARD      // Minimal assistance
}

model HomeworkFile {
  id              String           @id @default(cuid())
  sessionId       String
  session         HomeworkSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  filename        String
  mimeType        String
  fileUrl         String           // URL to stored file
  fileSize        Int?             // Size in bytes
  ocrStatus       OcrStatus        @default(PENDING)
  extractedText   String?          @db.Text
  ocrConfidence   Float?           // 0-1 confidence score
  ocrMetadata     Json?            // Additional OCR metadata (word positions, etc.)
  inputType       HomeworkInputType @default(UPLOAD)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([sessionId])
  @@index([ocrStatus])
}

enum OcrStatus {
  PENDING
  PROCESSING
  COMPLETE
  FAILED
}

enum HomeworkInputType {
  UPLOAD        // File upload
  CAMERA        // Camera capture
  TEXT          // Direct text input
  DOCUMENT      // PDF/Document upload
}

model HomeworkWorkProduct {
  id              String           @id @default(cuid())
  sessionId       String
  session         HomeworkSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  step            HomeworkSessionStatus
  inputType       String           // "analysis", "plan", "solution_step", "verification"
  inputData       Json?            // Input provided by learner
  outputData      Json             // AI-generated guidance/feedback
  isComplete      Boolean          @default(false)
  confidence      Float?           // AI confidence in the output
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([sessionId])
  @@index([step])
}

model HomeworkHint {
  id              String           @id @default(cuid())
  sessionId       String
  session         HomeworkSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  step            HomeworkSessionStatus
  hintNumber      Int              // 1, 2, or 3 for the step
  hintType        HomeworkHintType
  content         String           @db.Text
  wasHelpful      Boolean?         // Learner feedback
  createdAt       DateTime         @default(now())

  @@index([sessionId])
  @@index([step])
}

enum HomeworkHintType {
  NUDGE           // Gentle pointer in right direction
  EXPLANATION     // Explain a concept
  EXAMPLE         // Show a similar example
  DIRECT          // More direct guidance
}

// =============================================================================
// Self-Regulation Hub Models
// =============================================================================

model RegulationSession {
  id                String               @id @default(cuid())
  learnerId         String
  learner           Learner              @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  activityId        String               // Reference to specific activity (e.g., "breathing_478", "grounding_54321")
  activityType      RegulationActivityType
  emotionBefore     String?              // Emotion identifier before activity
  emotionLevelBefore Int?                // 1-5 scale
  emotionAfter      String?              // Emotion identifier after activity
  emotionLevelAfter Int?                 // 1-5 scale
  durationSeconds   Int                  @default(0)
  completed         Boolean              @default(false)
  effectiveness     Int?                 // 1-5 rating from learner
  notes             String?              @db.Text
  triggeredBy       String?              // "manual", "focus_monitor", "scheduled"
  context           Json?                // Additional context (subject, time of day, etc.)
  startedAt         DateTime             @default(now())
  completedAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  @@index([learnerId])
  @@index([activityType])
  @@index([startedAt])
}

model EmotionHistory {
  id          String    @id @default(cuid())
  learnerId   String
  learner     Learner   @relation(fields: [learnerId], references: [id], onDelete: Cascade)
  emotion     String    // "happy", "sad", "angry", "anxious", "calm", "frustrated", "tired", "excited"
  level       Int       // 1-5 intensity scale
  trigger     String?   // What caused this emotion (optional)
  strategy    String?   // Strategy used or suggested
  context     Json?     // Additional context (activity, subject, time)
  source      String    @default("manual") // "manual", "check_in", "post_activity", "focus_monitor"
  notifyParent Boolean  @default(false) // Whether to notify parent (high distress)
  timestamp   DateTime  @default(now())
  createdAt   DateTime  @default(now())

  @@index([learnerId])
  @@index([emotion])
  @@index([timestamp])
}

enum RegulationActivityType {
  BREATHING     // Guided breathing exercises
  MOVEMENT      // Physical movement breaks
  GROUNDING     // 5-4-3-2-1 sensory grounding, body scan
  SENSORY       // Fidget activities, calm sounds, visual relaxation
}
