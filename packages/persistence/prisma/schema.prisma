generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql" // Default to Postgres; update here only if you intentionally change databases
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(cuid())
  type      String
  name      String
  region    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  users      User[]
  learners   Learner[]
  proposals  DifficultyProposal[]
  sessions   Session[]
  notices    Notification[]
  curriculumTopics CurriculumTopic[]
  contentItems     ContentItem[]
  roleAssignments  RoleAssignment[]
  telemetryEvents  TelemetryEvent[]
  experiments      Experiment[]
  feedbacks        Feedback[]
  usageRecords     TenantUsage[]
  limits           TenantLimits?
  auditLogs        AuditLogEntry[]
  safetyIncidents  SafetyIncident[]
  config           TenantConfig?
  districts        District[]
  schools          School[]
  subscription     Subscription?
}

model TenantConfig {
  id               String   @id @default(cuid())
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  tenantId         String   @unique
  defaultRegion    String
  allowedProviders Json     // Array of provider names
  dataResidency    String?
  curricula        Json     // Array of curriculum config objects
}

model District {
  id        String   @id @default(cuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String
  name      String
  country   String
  createdAt DateTime @default(now())

  schools   School[]
}

model School {
  id         String    @id @default(cuid())
  tenant     Tenant    @relation(fields: [tenantId], references: [id])
  tenantId   String
  district   District? @relation(fields: [districtId], references: [id])
  districtId String?
  name       String
  city       String?
  createdAt  DateTime  @default(now())
}

model User {
  id        String      @id @default(cuid())
  email     String      @unique
  name      String?
  createdAt DateTime    @default(now())

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  tenantId  String

  // Email preferences for unsubscribe support
  emailPreferences Json? // EmailPreferences object

  // Password reset token
  passwordResetToken     String?   @unique
  passwordResetExpiresAt DateTime?

  roles     RoleAssignment[]
  learners  Learner[]   @relation("LearnerOwner")
  notices   Notification[] @relation("NotificationRecipient")
  contentItems ContentItem[]
  feedbacks Feedback[]
  auditLogs AuditLogEntry[]
}

model RoleAssignment {
  id         String   @id @default(cuid())
  user       User     @relation(fields: [userId], references: [id])
  userId     String
  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  tenantId   String
  districtId String?
  schoolId   String?
  role       String
  createdAt  DateTime @default(now())

  @@unique([userId, tenantId], name: "userId_tenantId")
}

model Learner {
  id        String     @id @default(cuid())
  displayName String
  currentGrade Int
  region      String
  createdAt   DateTime  @default(now())

  tenant    Tenant      @relation(fields: [tenantId], references: [id])
  tenantId  String

  owner     User        @relation("LearnerOwner", fields: [ownerId], references: [id])
  ownerId   String

  brainProfile BrainProfile?
  sessions     Session[]
  proposals    DifficultyProposal[]
  notices      Notification[]
  telemetryEvents TelemetryEvent[]
  progressSnapshots SubjectProgressSnapshot[]
  experimentAssignments ExperimentAssignment[]
  feedbacks    Feedback[]
  safetyIncidents SafetyIncident[]
}

model BrainProfile {
  id          String   @id @default(cuid())
  learner     Learner  @relation(fields: [learnerId], references: [id])
  learnerId   String   @unique
  region      String
  currentGrade Int
  gradeBand   String
  // Store subject levels and neurodiversity/preferences as JSON for now
  subjectLevels Json
  neurodiversity Json
  preferences   Json
  updatedAt    DateTime @default(now())
}

model DifficultyProposal {
  id          String   @id @default(cuid())
  learner     Learner  @relation(fields: [learnerId], references: [id])
  learnerId   String
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String

  subject     String
  fromLevel   Int
  toLevel     Int
  direction   String
  rationale   String
  createdBy   String   // "system" | "teacher" | "parent"
  createdAt   DateTime @default(now())
  status      String   // "pending" | "approved" | "rejected"
  decidedById String?
  decidedAt   DateTime?
  decisionNotes String?
}

model Session {
  id        String   @id @default(cuid())
  learner   Learner  @relation(fields: [learnerId], references: [id])
  learnerId String
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String

  date      String
  subject   String
  status    String
  plannedMinutes Int
  actualMinutes  Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  activities SessionActivity[]
}

model SessionActivity {
  id          String   @id @default(cuid())
  session     Session  @relation(fields: [sessionId], references: [id])
  sessionId   String

  learnerId   String
  subject     String
  type        String    // "micro_lesson" | "guided_practice" | ...
  title       String
  instructions String
  estimatedMinutes Int
  status      String    // "pending" | "in_progress" | "completed" | "skipped"
  startedAt   DateTime?
  completedAt DateTime?
}

model Notification {
  id        String   @id @default(cuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String

  learner   Learner  @relation(fields: [learnerId], references: [id])
  learnerId String

  recipient User     @relation("NotificationRecipient", fields: [recipientUserId], references: [id])
  recipientUserId String

  audience  String
  type      String
  title     String
  body      String
  status    String   // "unread" | "read"
  createdAt DateTime @default(now())

  relatedDifficultyProposalId String?
  relatedBaselineAssessmentId String?
  relatedSessionId            String?
}

model TelemetryEvent {
  id        String   @id @default(cuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String

  learner   Learner  @relation(fields: [learnerId], references: [id])
  learnerId String

  type      String
  subject   String?
  payload   Json
  createdAt DateTime @default(now())
}

model SubjectProgressSnapshot {
  id        String   @id @default(cuid())
  learner   Learner  @relation(fields: [learnerId], references: [id])
  learnerId String

  subject   String
  date      String   // YYYY-MM-DD
  masteryScore     Float
  minutesPracticed Int
  difficultyLevel  Int

  @@unique([learnerId, subject, date], name: "learnerId_subject_date")
}

model CurriculumTopic {
  id          String   @id @default(cuid())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String

  subject     String
  grade       Int
  region      String
  standard    String
  code        String?
  title       String
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  contentItems ContentItem[]
}

model ContentItem {
  id          String   @id @default(cuid())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String

  topic       CurriculumTopic @relation(fields: [topicId], references: [id])
  topicId     String

  subject     String
  grade       Int
  type        String
  title       String
  body        String

  questionFormat String?
  options        Json?
  correctAnswer  String?
  accessibilityNotes String?

  status      String
  createdBy   User     @relation(fields: [createdByUserId], references: [id])
  createdByUserId String

  aiGenerated Boolean  @default(false)
  aiModel     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
}

model Experiment {
  id          String   @id @default(cuid())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String

  key         String
  name        String
  description String?
  status      String   // "draft" | "running" | "paused" | "completed"

  variants    Json     // [{id, key, label, description}]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())

  assignments ExperimentAssignment[]
}

model ExperimentAssignment {
  id           String     @id @default(cuid())
  experiment   Experiment @relation(fields: [experimentId], references: [id])
  experimentId String

  learner      Learner    @relation(fields: [learnerId], references: [id])
  learnerId    String

  variantKey   String
  assignedAt   DateTime @default(now())

  @@unique([experimentId, learnerId], name: "experimentId_learnerId")
}

model Feedback {
  id          String   @id @default(cuid())
  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  tenantId    String

  learner     Learner? @relation(fields: [learnerId], references: [id])
  learnerId   String?

  user        User?    @relation(fields: [userId], references: [id])
  userId      String?

  targetType  String
  targetId    String
  role        String
  rating      Int
  label       String?
  comment     String?
  experimentKey String?
  variantKey  String?

  createdAt   DateTime @default(now())
}

model TenantUsage {
  id              String   @id @default(cuid())
  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  tenantId        String

  date            String
  llmCalls        Int      @default(0)
  tutorTurns      Int      @default(0)
  sessionsPlanned Int      @default(0)
  safetyIncidents Int      @default(0)

  @@unique([tenantId, date], name: "tenantId_date")
}

model TenantLimits {
  id                 String  @id @default(cuid())
  tenant             Tenant  @relation(fields: [tenantId], references: [id])
  tenantId           String  @unique

  maxDailyLlmCalls   Int?
  maxDailyTutorTurns Int?
  allowedProviders   Json?
  blockedProviders   Json?
}

model AuditLogEntry {
  id        String   @id @default(cuid())
  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  tenantId  String

  user      User     @relation(fields: [userId], references: [id])
  userId    String

  type      String
  message   String
  meta      Json?
  createdAt DateTime @default(now())
}

model SafetyIncident {
  id               String   @id @default(cuid())
  tenant           Tenant   @relation(fields: [tenantId], references: [id])
  tenantId         String
  learner          Learner? @relation(fields: [learnerId], references: [id])
  learnerId        String?
  type             String
  severity         String
  message          String
  rawModelResponse String?
  createdAt        DateTime @default(now())
}

// ============================================================================
// Subscription & Payment Models
// ============================================================================

model Subscription {
  id                   String   @id @default(cuid())
  tenant               Tenant   @relation(fields: [tenantId], references: [id])
  tenantId             String   @unique

  // Stripe identifiers
  stripeCustomerId     String?  @unique
  stripeSubscriptionId String?  @unique
  stripePriceId        String?

  // Subscription status and tier
  status               String   // NONE, TRIAL_ACTIVE, TRIAL_EXPIRED, PILOT_ACTIVE, PILOT_EXPIRED, ACTIVE, PAST_DUE, CANCELLED, EXPIRED
  tier                 String   // FREE, BASIC, PRO, ENTERPRISE

  // Trial information
  trialStartedAt       DateTime?
  trialEndsAt          DateTime?
  hasUsedTrial         Boolean  @default(false)

  // Pilot information (for districts)
  pilotStartedAt       DateTime?
  pilotEndsAt          DateTime?
  hasUsedPilot         Boolean  @default(false)
  pilotMaxLearners     Int?
  pilotMaxSchools      Int?

  // Subscription dates
  currentPeriodStart   DateTime?
  currentPeriodEnd     DateTime?
  cancelledAt          DateTime?
  cancelAtPeriodEnd    Boolean  @default(false)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  payments             Payment[]
}

model Payment {
  id                    String   @id @default(cuid())
  subscription          Subscription @relation(fields: [subscriptionId], references: [id])
  subscriptionId        String

  // Stripe identifiers
  stripePaymentIntentId String?  @unique
  stripeInvoiceId       String?  @unique

  // Payment details
  amount                Int      // Amount in cents
  currency              String   // e.g., "usd"
  status                String   // succeeded, pending, failed, refunded

  // Invoice details
  invoiceNumber         String?
  invoicePdfUrl         String?
  hostedInvoiceUrl      String?

  // Metadata
  description           String?
  failureReason         String?

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}
